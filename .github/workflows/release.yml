name: Auto Release

# Automatische Release-Erstellung bei Git-Tags (v1.0.0, v2.1.3, etc.)

on:
  push:
    tags:
      - 'v*'  # Triggert bei v1.0.0, v2.1.3, etc.

permissions:
  contents: write  # Für Release-Erstellung

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Verify tag format
        run: |
          if [[ ! "${{ steps.version.outputs.VERSION }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid tag format. Expected: v1.0.0"
            exit 1
          fi
          echo "✅ Tag format valid"

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release_notes.md <<EOF
          # AutoUpdater ${{ steps.version.outputs.VERSION }}

          ## What's Changed

          $(git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s (%an)")

          ## Installation

          \`\`\`bash
          # Bootstrap minimal
          curl -sS https://raw.githubusercontent.com/7onnie/AutoUpdater/master/bootstrap/bootstrap_minimal.sh

          # Oder als Submodule
          git submodule add https://github.com/7onnie/AutoUpdater.git
          \`\`\`

          ## Documentation

          - [Setup Guide](https://github.com/7onnie/AutoUpdater/blob/master/docs/SETUP.md)
          - [Deployment Guide](https://github.com/7onnie/AutoUpdater/blob/master/docs/DEPLOYMENT.md)
          - [Modes Comparison](https://github.com/7onnie/AutoUpdater/blob/master/docs/MODES.md)
          - [Migration Guide](https://github.com/7onnie/AutoUpdater/blob/master/docs/MIGRATION.md)
          - [Script Migration Tool](https://github.com/7onnie/AutoUpdater/blob/master/docs/SCRIPT_MIGRATION.md)
          EOF

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ steps.version.outputs.VERSION }} \
            --title "AutoUpdater ${{ steps.version.outputs.VERSION }}" \
            --notes-file release_notes.md \
            lib/auto_update_engine.sh \
            lib/auto_update_github_only.sh \
            lib/auto_update_git_only.sh \
            lib/auto_update_direct_only.sh \
            bootstrap/bootstrap_minimal.sh \
            bootstrap/bootstrap_with_fallback.sh \
            standalone/auto_update_standalone.sh

      - name: Create Distribution Archive
        run: |
          mkdir -p dist
          tar -czf dist/AutoUpdater_${{ steps.version.outputs.VERSION }}.tar.gz \
            lib/ \
            bootstrap/ \
            standalone/ \
            examples/ \
            docs/ \
            README.md \
            LICENSE

      - name: Upload Distribution Archive
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ steps.version.outputs.VERSION }} \
            dist/AutoUpdater_${{ steps.version.outputs.VERSION }}.tar.gz

      - name: Verify Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Release created successfully:"
          gh release view ${{ steps.version.outputs.VERSION }}

      - name: Update latest tag
        run: |
          git tag -f latest
          git push -f origin latest
          echo "✅ Updated 'latest' tag to ${{ steps.version.outputs.VERSION }}"

  notify:
    needs: release
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Success notification
        run: |
          echo "✅ Release ${{ steps.version.outputs.VERSION }} published successfully!"
          echo "View release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }}"

      # Optional: Slack/Discord Notification
      # - name: Notify Slack
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: 'New AutoUpdater release ${{ steps.version.outputs.VERSION }} published!'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
